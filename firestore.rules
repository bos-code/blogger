rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated AND email is verified
    function isAuthenticated() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    // Get user's role from Firestore (single source of truth)
    function getUserRole() {
      if (!isAuthenticated()) return null;
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Check if user is writer (includes admin)
    function isWriter() {
      let role = getUserRole();
      return isAuthenticated() && (role == 'writer' || role == 'admin');
    }
    
    // Check if user is the owner of a resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if attempting to modify admin role
    function isModifyingAdminRole(userId) {
      let targetUser = get(/databases/$(database)/documents/users/$(userId));
      let currentRole = targetUser.data.role;
      let newRole = request.resource.data.role;
      // Check if changing TO admin or FROM admin
      return (currentRole == 'admin' || newRole == 'admin') && currentRole != newRole;
    }
    
    // Validate role value
    function isValidRole(role) {
      return role in ['user', 'writer', 'admin', 'reader'];
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // READ RULES
      allow read: if isAuthenticated() && (
        // Admin can read all users
        isAdmin() ||
        // Users can read their own document
        isOwner(userId)
      );
      
      // CREATE RULES
      allow create: if isAuthenticated() && (
        // Only admin can create users with roles
        (isAdmin() && isValidRole(request.resource.data.role)) ||
        // Regular signup creates user with default 'user' role
        (!('role' in request.resource.data) || request.resource.data.role == 'user')
      );
      
      // UPDATE RULES
      allow update: if isAuthenticated() && (
        // Admin can update any user (but cannot modify other admins)
        (isAdmin() && 
         !isModifyingAdminRole(userId) &&
         // Cannot change role to admin
         (!('role' in request.resource.data) || 
          request.resource.data.role != 'admin')) ||
        // Users can update their own profile (but not role)
        (isOwner(userId) && 
         !('role' in request.resource.data) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'photoURL', 'email', 'updatedAt']))
      );
      
      // DELETE RULES
      allow delete: if isAuthenticated() && (
        // Only admin can delete users
        isAdmin() ||
        // Users can delete their own account (but not if they're admin)
        (isOwner(userId) && resource.data.role != 'admin')
      );
    }
    
    // ============================================
    // POSTS COLLECTION
    // ============================================
    match /posts/{postId} {
      // READ RULES
      allow read: if isAuthenticated() && (
        // Admin can read all posts
        isAdmin() ||
        // Writers can read all approved posts and their own posts
        (isWriter() && (resource.data.status == 'approved' || resource.data.authorId == request.auth.uid)) ||
        // Regular users can only read approved posts
        (resource.data.status == 'approved')
      );
      
      // CREATE RULES
      allow create: if isAuthenticated() && (
        // Admin can create posts
        isAdmin() ||
        // Writers can create posts
        (isWriter() && request.resource.data.authorId == request.auth.uid)
      );
      
      // UPDATE RULES
      allow update: if isAuthenticated() && (
        // Admin can update any post
        isAdmin() ||
        // Writers can update their own posts
        (isWriter() && resource.data.authorId == request.auth.uid)
      );
      
      // DELETE RULES
      allow delete: if isAuthenticated() && (
        // Admin can delete any post
        isAdmin() ||
        // Writers can delete their own posts
        (isWriter() && resource.data.authorId == request.auth.uid)
      );
    }
    
    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      // READ: All authenticated users can read categories
      allow read: if isAuthenticated();
      
      // CREATE/UPDATE/DELETE: Only admins
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // COMMENTS COLLECTION
    // ============================================
    match /comments/{commentId} {
      // READ: All authenticated users can read comments
      allow read: if isAuthenticated();
      
      // CREATE: All authenticated users (except readers)
      allow create: if isAuthenticated() && getUserRole() != 'reader';
      
      // UPDATE/DELETE: Author or admin
      allow update, delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.authorId == request.auth.uid
      );
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // READ: Users can only read their own notifications
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
      
      // CREATE: Only system (admin) can create
      allow create: if isAdmin();
      
      // UPDATE: Users can update their own notifications
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
      
    // DELETE: Users can delete their own notifications
    allow delete: if isAuthenticated() && (
      isAdmin() ||
      resource.data.userId == request.auth.uid
    );
  }
  
  // ============================================
  // MESSAGES COLLECTION (Contact Form)
  // ============================================
  match /messages/{messageId} {
    // CREATE: Anyone can send a message (no auth required for contact form)
    allow create: if request.resource.data.keys().hasAll(['name', 'email', 'message', 'createdAt']) &&
                     request.resource.data.name is string &&
                     request.resource.data.email is string &&
                     request.resource.data.message is string &&
                     request.resource.data.name.size() >= 3 &&
                     request.resource.data.message.size() >= 10;
    
    // READ: Only admins can read messages
    allow read: if isAdmin();
    
    // UPDATE: Only admins can update messages (e.g., mark as read)
    allow update: if isAdmin();
    
    // DELETE: Only admins can delete messages
    allow delete: if isAdmin();
  }
}
}
